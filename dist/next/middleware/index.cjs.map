{"version":3,"sources":["../../../src/next/middleware/create-auth-middleware.ts"],"names":["NextResponse"],"mappings":";;;;;AAkBA,IAAM,4BAAA,GAA+B,WAAA;AAiE9B,SAAS,oBAAA,CAAqB,MAAA,GAA+B,EAAC,EAAG;AACtE,EAAA,MAAM;AAAA,IACJ,iBAAA,GAAoB,CAAC,YAAY,CAAA;AAAA,IACjC,SAAA,GAAY,QAAA;AAAA,IACZ,yBAAA;AAAA,IACA,eAAA,GAAkB,CAAC,QAAQ,CAAA;AAAA,IAC3B,UAAA,GAAa;AAAA,GACf,GAAI,MAAA;AAEJ,EAAA,OAAO,SAAS,eAAe,OAAA,EAAsB;AACnD,IAAA,MAAM,EAAE,QAAA,EAAS,GAAI,OAAA,CAAQ,OAAA;AAC7B,IAAA,MAAM,aAAA,GAAgB,OAAA,CAAQ,OAAA,CAAQ,GAAA,CAAI,UAAU,CAAA;AACpD,IAAA,MAAM,UAAA,GAAa,OAAA,CAAQ,aAAA,EAAe,KAAK,CAAA;AAG/C,IAAA,MAAM,kBAAkB,iBAAA,CAAkB,IAAA;AAAA,MAAK,CAAC,MAAA,KAC9C,QAAA,CAAS,UAAA,CAAW,MAAM;AAAA,KAC5B;AAGA,IAAA,MAAM,mBAAmB,eAAA,CAAgB,IAAA;AAAA,MAAK,CAAC,IAAA,KAC7C,QAAA,CAAS,UAAA,CAAW,IAAI;AAAA,KAC1B;AAGA,IAAA,IAAI,eAAA,IAAmB,CAAC,UAAA,EAAY;AAClC,MAAA,MAAM,QAAA,GAAW,IAAI,GAAA,CAAI,SAAA,EAAW,QAAQ,GAAG,CAAA;AAE/C,MAAA,QAAA,CAAS,YAAA,CAAa,GAAA,CAAI,MAAA,EAAQ,QAAQ,CAAA;AAC1C,MAAA,OAAOA,mBAAA,CAAa,SAAS,QAAQ,CAAA;AAAA,IACvC;AAGA,IAAA,IACE,gBAAA,IACA,cACA,yBAAA,EACA;AACA,MAAA,MAAM,YAAA,GAAe,IAAI,GAAA,CAAI,yBAAA,EAA2B,QAAQ,GAAG,CAAA;AACnE,MAAA,OAAOA,mBAAA,CAAa,SAAS,YAAY,CAAA;AAAA,IAC3C;AAGA,IAAA,OAAOA,oBAAa,IAAA,EAAK;AAAA,EAC3B,CAAA;AACF;AAaO,SAAS,qBAAA,GAAkC;AAChD,EAAA,OAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAQL;AAAA,GACF;AACF","file":"index.cjs","sourcesContent":["/**\n * Next.js middleware factory for Firebase session-based auth.\n *\n * This middleware performs a **cookie presence check only** (edge-safe).\n * Full cryptographic verification happens in Node runtime (route handlers, server components).\n *\n * Why presence-only?\n * - Edge middleware can't import firebase-admin (requires Node runtime).\n * - Presence check is fast and prevents most unauthorized access attempts.\n * - Server guards provide the actual security boundary with full JWT verification.\n */\nimport { NextResponse } from 'next/server';\nimport type { NextRequest } from 'next/server';\n\n/**\n * Default session cookie name.\n * Hardcoded here to avoid importing Node.js modules in edge runtime.\n */\nconst FIREBASE_SESSION_COOKIE_NAME = '__session';\n\nexport interface AuthMiddlewareConfig {\n  /**\n   * Path prefixes that require authentication.\n   * Default: ['/dashboard']\n   *\n   * @example ['/dashboard', '/admin', '/api/protected']\n   */\n  protectedPrefixes?: string[];\n\n  /**\n   * Path to redirect to when session cookie is missing.\n   * Default: '/login'\n   */\n  loginPath?: string;\n\n  /**\n   * Optional: Path to redirect to when session cookie is present on public pages.\n   * Useful for redirecting away from /login if already authenticated.\n   * Default: undefined (no redirect)\n   *\n   * @example '/dashboard'\n   */\n  authenticatedRedirectPath?: string;\n\n  /**\n   * Optional: Paths that should redirect authenticated users.\n   * Only applies when authenticatedRedirectPath is set.\n   * Default: ['/login']\n   *\n   * @example ['/login', '/signup']\n   */\n  publicOnlyPaths?: string[];\n\n  /**\n   * Optional: Custom cookie name if not using default '__session'.\n   * Default: '__session'\n   */\n  cookieName?: string;\n}\n\n/**\n * Creates a Next.js middleware function that checks for Firebase session cookie presence.\n *\n * @example\n * ```typescript\n * // middleware.ts\n * import { createAuthMiddleware } from '@volcanica/firebase-auth-nextjs/next/middleware';\n *\n * export default createAuthMiddleware({\n *   protectedPrefixes: ['/dashboard', '/api/protected'],\n *   loginPath: '/login',\n *   authenticatedRedirectPath: '/dashboard',\n *   publicOnlyPaths: ['/login', '/signup'],\n * });\n *\n * export const config = {\n *   matcher: [\n *     // Match all paths except static files and API routes you want public\n *     '/((?!_next/static|_next/image|favicon.ico|api/public).*)',\n *   ],\n * };\n * ```\n */\nexport function createAuthMiddleware(config: AuthMiddlewareConfig = {}) {\n  const {\n    protectedPrefixes = ['/dashboard'],\n    loginPath = '/login',\n    authenticatedRedirectPath,\n    publicOnlyPaths = ['/login'],\n    cookieName = FIREBASE_SESSION_COOKIE_NAME,\n  } = config;\n\n  return function authMiddleware(request: NextRequest) {\n    const { pathname } = request.nextUrl;\n    const sessionCookie = request.cookies.get(cookieName);\n    const hasSession = Boolean(sessionCookie?.value);\n\n    // Check if current path requires authentication\n    const isProtectedPath = protectedPrefixes.some((prefix) =>\n      pathname.startsWith(prefix)\n    );\n\n    // Check if current path is public-only (e.g., login page)\n    const isPublicOnlyPath = publicOnlyPaths.some((path) =>\n      pathname.startsWith(path)\n    );\n\n    // Case 1: Protected path without session → redirect to login\n    if (isProtectedPath && !hasSession) {\n      const loginUrl = new URL(loginPath, request.url);\n      // Preserve the attempted URL for post-login redirect\n      loginUrl.searchParams.set('from', pathname);\n      return NextResponse.redirect(loginUrl);\n    }\n\n    // Case 2: Public-only path with session → redirect to authenticated area\n    if (\n      isPublicOnlyPath &&\n      hasSession &&\n      authenticatedRedirectPath\n    ) {\n      const dashboardUrl = new URL(authenticatedRedirectPath, request.url);\n      return NextResponse.redirect(dashboardUrl);\n    }\n\n    // Case 3: Allow request to proceed\n    return NextResponse.next();\n  };\n}\n\n/**\n * Helper to create a recommended matcher config for Next.js middleware.\n *\n * @example\n * ```typescript\n * import { createAuthMiddleware, getRecommendedMatcher } from '@volcanica/firebase-auth-nextjs/next/middleware';\n *\n * export default createAuthMiddleware({ ... });\n * export const config = { matcher: getRecommendedMatcher() };\n * ```\n */\nexport function getRecommendedMatcher(): string[] {\n  return [\n    /**\n     * Match all request paths except for the ones starting with:\n     * - _next/static (static files)\n     * - _next/image (image optimization)\n     * - favicon.ico (favicon file)\n     * - public folder content (if you serve assets from /public)\n     */\n    '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',\n  ];\n}\n\n"]}